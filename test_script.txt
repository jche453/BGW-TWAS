######################### Test on 1KG Example Data
bfGWAS_SS_dir="/net/fantasia/home/yjingj/GIT/bfGWAS_SS"
test_dir="/net/fantasia/home/yjingj/GIT/bfGWAS_SS/1KG_example/Test_Wkdir"
cd $test_dir

## Using Old bfGWAS 
time ~/GIT/bfGWAS/bin/Estep_mcmc \
-vcf ${bfGWAS_SS_dir}/1KG_example/ExData/vcfs/CFH_REGION_1KG.vcf.gz \
-p ${bfGWAS_SS_dir}/1KG_example/ExData/phenoAMD_1KG.txt \
-a ${bfGWAS_SS_dir}/1KG_example/ExData/annos/Anno_CFH_REGION_1KG.gz \
-fcode ${bfGWAS_SS_dir}/1KG_example/ExData/AnnoCode6.txt \
-hfile ${bfGWAS_SS_dir}/1KG_example/Test_Wkdir/hypval.current \
-GTfield GT -bvsrm -maf 0.005 -win 100 -smin 0 -smax 5 -w 50000 -s 100000 \
-o CFH_REGION_1KG -initype 3 -seed 2017 > ${test_dir}/test_old.output.txt &

real    8m36.933s
user    8m33.808s
sys     0m2.610s

## Save Annotation file in the format of chr/pos/ref/alt/func
~/Scripts/Shell_Script/ConvertAnnoFile.sh ${bfGWAS_SS_dir}/1KG_example/ExData/vcfs/CFH_REGION_1KG.vcf.gz Anno_CFH_REGION_1KG.gz CFH_REGION_1KG 

### Run bfGWAS_SS with individual level data and new ANNO file
time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-vcf ${bfGWAS_SS_dir}/1KG_example/ExData/vcfs/CFH_REGION_1KG.vcf.gz \
-p ${bfGWAS_SS_dir}/1KG_example/ExData/phenoAMD_1KG.txt \
-a ${bfGWAS_SS_dir}/1KG_example/ExData/annos/Anno_CFH_REGION_1KG.txt.gz \
-fcode ${bfGWAS_SS_dir}/1KG_example/ExData/AnnoCode6.txt \
-hfile ${bfGWAS_SS_dir}/1KG_example/Test_Wkdir/hypval.current \
-GTfield GT -bvsrm -maf 0.005 -win 100 -smin 0 -smax 5 -w 50000 -s 100000 \
-o CFH_REGION_1KG_SS -initype 3 -LDwindow 500000 -seed 2017 \
-saveSS \
> ${test_dir}/test_SS.output.txt &

real    2m1.698s
user    2m0.211s
sys     0m0.925s

### Run bfGWAS_SS with Summary data

time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-score ${bfGWAS_SS_dir}/1KG_example/Test_Wkdir/output/CFH_REGION_1KG_SS.score.txt \
-cov ${bfGWAS_SS_dir}/1KG_example/Test_Wkdir/output/CFH_REGION_1KG_SS.cov.txt \
-n 2504 -rv 0.250064 -inputSS \
-a ${bfGWAS_SS_dir}/1KG_example/ExData/annos/Anno_CFH_REGION_1KG.txt.gz \
-fcode ${bfGWAS_SS_dir}/1KG_example/ExData/AnnoCode6.txt \
-hfile ${bfGWAS_SS_dir}/1KG_example/Test_Wkdir/hypval.current \
-GTfield GT -bvsrm -maf 0.005 -win 100 -smin 0 -smax 5 -w 50000 -s 100000 \
-o CFH_REGION_1KG_ReadSS -initype 3 -seed 2017 > ${test_dir}/ReadSS_test.output.txt &

real    0m8.684s
user    0m7.956s
sys     0m0.277s


######################### Test on AMD data 
bfGWAS_SS_dir="/net/fantasia/home/yjingj/GIT/bfGWAS_SS"
test_dir="/net/fantasia/home/yjingj/GIT/bfGWAS_SS/1KG_example/Test_Wkdir"

## Convert Annotation file
zcat ${test_dir}/amd_chr1_test.vcf.gz | awk 'NF>10{print $1"\t"$2"\t"$4"\t"$5}' > Anno_amd_chr1_test.temp
zcat Anno_amd_chr1_test.gz | cut -f4 > Anno_amd_chr1_test.tempFunc
paste Anno_amd_chr1_test.temp Anno_amd_chr1_test.tempFunc > Anno_amd_chr1_test.txt

###### Test on a sub amd dataset

## Using Old bfGWAS 
time ~/GIT/bfGWAS/bin/Estep_mcmc \
-vcf ${test_dir}/amd_chr1_test.vcf.gz \
-p /net/wonderland/home/yjingj/AMD/amd_pheno_scaled.txt.gz \
-a ${test_dir}/Anno_amd_chr1_test.gz \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt -hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current -GTfield EC -maf 0.005 -bvsrm -rmin 1 -rmax 1 \
-smin 0 -smax 10 -win 100 -o amd_test_old -w 50000 -s 100000 \
-initype 3 -rv 1 -seed 2017 \
> ${test_dir}/AMDtest_old.output.txt &

real    5m44.080s
user    5m42.065s
sys     0m1.990s

## Using individual level data
time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-vcf ${test_dir}/amd_chr1_test.vcf.gz \
-p /net/wonderland/home/yjingj/AMD/amd_pheno_scaled.txt.gz \
-a ${test_dir}/Anno_amd_chr1_test.txt \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt \
-hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current -GTfield EC -maf 0.005 -bvsrm -rmin 1 -rmax 1 -smin 0 \
-smax 10 -win 100 -o amd_test_SS -w 50000 -s 100000 \
-initype 3 -rv 1 -LDwindow 1000000 -seed 2017 \
-saveSS -zipSS > ${test_dir}/AMDtest_SS.output.txt &

> ${test_dir}/AMDtest_SS.output.txt

real    12m3.4s
user    12m2.3s
sys     0m1.326s

## Read SS 
time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-score ${test_dir}/output/amd_test_SS.score.txt.gz \
-cov ${test_dir}/output/amd_test_SS.cov.txt.gz \
-n 33976 -rv 1 -inputSS \
-a ${test_dir}/Anno_amd_chr1_test.txt \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt \
-hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current \
-bvsrm -rmin 1 -rmax 1 -smin 0 -smax 10 -win 100 \
-o amd_test_ReadSS -w 50000 -s 100000 -initype 3 -seed 2017 \
> ${test_dir}/AMDtest_ReadSS.output.txt &

real    0m1.789s
user    0m1.203s
sys     0m0.092s 

############ Memory usage : 527MB ; computation time :

bfGWAS_SS_dir="/net/fantasia/home/yjingj/GIT/bfGWAS_SS"
test_dir="/net/wonderland/home/yjingj/AMD/Test_bfGWAS_SS"

~/Scripts/Shell_Script/ConvertAnnoFile.sh /net/wonderland/home/yjingj/Data/AMD_Imputed_Filtered/chr1_Loci_1_sub1.vcf.gz /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation chr1_Loci_1_sub1 

### Test on block C3...

## Using Old bfGWAS 
time ~/GIT/bfGWAS/bin/Estep_mcmc \
-vcf /net/wonderland/home/yjingj/Data/AMD_Imputed_Filtered/chr1_Loci_1_sub1.vcf.gz \
-p /net/wonderland/home/yjingj/AMD/amd_pheno_scaled.txt.gz \
-a /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation/Anno_chr1_Loci_1_sub1.gz \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt -hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current -GTfield EC -maf 0.005 -bvsrm -rmin 1 -rmax 1 \
-smin 0 -smax 15 -win 100 -o amd_chr1_Loci_1_sub1_old \
-w 50000 -s 100000 -initype 3 -rv 1 -seed 2017 \
> ${test_dir}/amd_chr1_Loci_1_sub1_old.output.txt &

real    101m34.207s 
user 	101m31.774s
sys     0m5.532s 


## Using individual level data, generate summary statistics
time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-vcf /net/wonderland/home/yjingj/Data/AMD_Imputed_Filtered/chr1_Loci_1_sub1.vcf.gz \
-p /net/wonderland/home/yjingj/AMD/amd_pheno_scaled.txt.gz \
-a /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation/Anno_chr1_Loci_1_sub1.txt.gz \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt \
-hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current \
-GTfield EC -maf 0.005 -bvsrm -rmin 1 -rmax 1 -smin 0 -smax 15 -win 100 \
-o amd_chr1_Loci_1_sub1_SS_2M -w 50000 -s 100000 -initype 3 -rv 1 \
-LDwindow 2000000 -seed 2017 \
-saveSS -zipSS > ${test_dir}/amd_chr1_Loci_1_sub1_SS.output.txt &

> ${test_dir}/AMDtest_SS.output.txt &

real    182m56.449s
user    182m34.882s
sys     0m27.783s

# bfGWAS Memory usage : MB ; computation time : 
# 77 m

## Read SS 
time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-score ${test_dir}/output/amd_chr1_Loci_1_sub1_SS.score.txt.gz \
-cov ${test_dir}/output/amd_chr1_Loci_1_sub1_SS.cov.txt.gz \
-n 33976 -rv 1 -inputSS \
-a /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation/Anno_chr1_Loci_1_sub1.txt.gz \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt \
-hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current \
-bvsrm -rmin 1 -rmax 1 -smin 0 -smax 15 -win 100 \
-o amd_chr1_Loci_1_sub1_ReadSS -w 50000 -s 100000 -initype 3 -seed 2017 \
> ${test_dir}/amd_chr1_Loci_1_sub1_ReadSS.output.txt &

## Read SS_2M
time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-score ${test_dir}/output/amd_chr1_Loci_1_sub1_SS_2M.score.txt.gz \
-cov ${test_dir}/output/amd_chr1_Loci_1_sub1_SS_2M.cov.txt.gz \
-n 33976 -rv 1 -inputSS \
-a /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation/Anno_chr1_Loci_1_sub1.txt.gz \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt \
-hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current \
-bvsrm -rmin 1 -rmax 1 -smin 0 -smax 15 -win 100 \
-o amd_chr1_Loci_1_sub1_ReadSS_max15 -w 50000 -s 100000 \
-initype 3 -seed 2017 \
> ${test_dir}/amd_chr1_Loci_1_sub1_ReadSS.output.txt &

## bfGWAS Memory usage : MB ; computation time : 
real    0m45.155s 
user    0m44.412s 
sys     0m0.689s

############ AMD Locus CHR19
# select_chr=19; bp_start=6218146; bp_end=7218146
# file=CHR19.005000001.007500000_FinalRelease

## Using Old bfGWAS 
time ~/GIT/bfGWAS/bin/Estep_mcmc \
-vcf /net/wonderland/home/yjingj/Data/AMD_Imputed_Filtered/${file}.vcf.gz \
-p /net/wonderland/home/yjingj/AMD/amd_pheno_scaled.txt.gz \
-a /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation/Anno_${file}.gz \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt -hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current -GTfield EC -maf 0.005 -bvsrm -rmin 1 -rmax 1 \
-smin 0 -smax 10 -win 100 -o ${file}_old \
-w 50000 -s 100000 -initype 3 -rv 1 -seed 2017 \
> ${test_dir}/amd_${file}_old.output.txt &


## Using individual level data, generate summary statistics
time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-vcf /net/wonderland/home/yjingj/Data/AMD_Imputed_Filtered/${file}.vcf.gz \
-p /net/wonderland/home/yjingj/AMD/amd_pheno_scaled.txt.gz \
-a /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation/Anno_${file}.txt.gz \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt \
-hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current \
-GTfield EC -maf 0.005 -bvsrm -rmin 1 -rmax 1 -smin 0 -smax 10 -win 100 \
-o ${file}_SS -w 50000 -s 100000 -initype 3 -rv 1 \
-LDwindow 1000000 -seed 2017 \
-saveSS -zipSS > ${test_dir}/amd_${file}_SS.output.txt &

time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-vcf /net/wonderland/home/yjingj/Data/AMD_Imputed_Filtered/${file}.vcf.gz \
-p /net/wonderland/home/yjingj/AMD/amd_pheno_scaled.txt.gz \
-a /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation/Anno_${file}.txt.gz \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt \
-hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current \
-GTfield EC -maf 0.005 -bvsrm -rmin 1 -rmax 1 -smin 0 -smax 10 -win 100 \
-o ${file}_SS_2M -w 50000 -s 100000 -initype 3 -rv 1 \
-LDwindow 2000000 -seed 2017 \
-saveSS -zipSS > ${test_dir}/amd_${file}_2M_SS.output.txt &


## Read SS 
time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-score ${test_dir}/output/${file}_SS.score.txt.gz \
-cov ${test_dir}/output/${file}_SS.cov.txt.gz \
-n 33976 -rv 1 -inputSS \
-a /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation/Anno_${file}.txt.gz \
-fcode /net/wonderland/home/yjingj/AMD/AnnoPartition/FuncAnno5.txt \
-hfile /net/wonderland/home/yjingj/AMD/AMD_Results/GVS_anno5/hypval.current \
-bvsrm -rmin 1 -rmax 1 -smin 0 -smax 10 -win 100 \
-o ${file}_ReadSS -w 50000 -s 100000 -initype 3 -seed 2017 \
> ${test_dir}/amd_${file}_ReadSS.output.txt &




###### profiling new model for AMD all genotype data

gprof -p -b ${GMGIT}/bin/gemma_newmodel_pg gmon.out > AMD_allgeno_gprof.txt
gprof -p -b ${GMGIT}/bin/gemma_newmodel_pg gmon.out > AMD_test_gprof.txt

###### Convert all AMD Anno files

cat /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation/vcf_filehead_withSubLoci.txt | while read file 
do
	echo $file
	~/Scripts/Shell_Script/ConvertAnnoFile.sh /net/wonderland/home/yjingj/Data/AMD_Imputed_Filtered/${file}.vcf.gz /net/wonderland/home/yjingj/Data/AMD/GVS_Annotation ${file} 
done



################## Save Genotype

time ${bfGWAS_SS_dir}/bin/Estep_mcmc \
-vcf ${bfGWAS_SS_dir}/1KG_example/ExData/vcfs/CFH_REGION_1KG.vcf.gz \
-p ${bfGWAS_SS_dir}/1KG_example/ExData/phenoAMD_1KG.txt \
-a ${bfGWAS_SS_dir}/1KG_example/ExData/annos/Anno_CFH_REGION_1KG.gz \
-fcode ${bfGWAS_SS_dir}/1KG_example/ExData/AnnoCode6.txt \
-hfile ${bfGWAS_SS_dir}/1KG_example/Test_Wkdir/hypval.current \
-GTfield GT -bvsrm -maf 0.005 -win 100 -smin 0 -smax 5 -w 10 -s 10 \
-o CFH_REGION_1KG -saveGeno





